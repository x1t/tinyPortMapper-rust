# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**tinyPortMapper-rust** is a lightweight, high-performance port forwarding tool (~95 Gbps). Rust rewrite of the C++ version with memory safety guarantees, using mio-based event-driven I/O.

## Build Commands

```bash
# Local release build (default)
make

# Debug build
make debug

# musl static build (for Alpine Linux)
make musl

# Cross-compilation (OpenWRT targets)
make arm          # ARMv7
make amd64        # x86_64
make mips24kc_be  # MIPS big-endian
make mips24kc_le  # MIPS little-endian
make x86          # i686

# Other platforms
make mingw        # Windows x86_64
make macos        # macOS x86_64

# Code quality
make test         # cargo test --release
make check        # cargo check (native + musl)
make clippy       # cargo clippy
make fmt          # cargo fmt --all
```

## Architecture

```
main.rs           # CLI parsing (clap), socket creation, event loop bootstrap
lib.rs            # Module exports, logging macros, utility functions
config.rs         # Config struct, constants (timeouts, buffer sizes)

event/
├── mod.rs        # EventLoop (mio Poll), TokenManager, shutdown handler
├── tcp.rs        # TcpHandler: accept → connect → splice/recv-send → close
├── udp.rs        # UdpHandler: datagram → session lookup → forward
├── timer.rs      # Periodic stats output (10s interval)
└── signals.rs    # SIGTERM/SIGINT handling

connection/
└── mod.rs        # TcpConnection (local+remote endpoints, splice pipes),
                  # UdpSession, FdInfo

manager/
└── mod.rs        # TcpConnectionManager, UdpSessionManager, LruCollector

fd_manager.rs     # Fd64 ↔ RawFd bidirectional mapping, FD lifecycle
lru.rs            # LRU cleanup with min-heap for timeout-based eviction
log.rs            # 7-level logger (never/fatal/error/warn/info/debug/trace)
stats.rs          # Atomic traffic counters (TCP/UDP bytes, connection count)
types/address.rs  # Address (IPv4/IPv6), 4to6/6to4 translation helpers
```

### Core Data Flow

```
main()
├─ CLI parsing → Config
├─ Create FdManager, TcpConnectionManager, UdpSessionManager
├─ Create TCP/UDP listen sockets (SO_REUSEADDR, SO_REUSEPORT)
└─ EventLoop::run()
    ├─ poll.poll() waits for I/O events
    ├─ TCP listener → on_accept() → TcpConnection (local + remote sockets)
    ├─ UDP listener → on_datagram() → UdpSession (connected UDP socket)
    ├─ Connection I/O → tcp.on_read/on_write() or udp.on_response()
    ├─ Timer (10s) → print stats
    └─ Timer (400ms) → LRU cleanup
```

### Key Abstractions

**Fd64**: u64 wrapper for cross-platform FD abstraction (Windows RawSocket vs Unix RawFd). Provides stable identifier for connection lifecycle.

**SplicePipe** (Linux only): Zero-copy forwarding using `splice()` syscall. Falls back to recv/send on non-Linux platforms.

**LruCollector**: Min-heap based LRU for O(log n) timeout eviction. TCP timeout: 360s, UDP timeout: 180s.

### Configuration Constants

| Constant | Value | Purpose |
|----------|-------|---------|
| `LISTEN_FD_BUF_SIZE` | 2MB | Listen socket buffer |
| `TIMER_INTERVAL_MS` | 400ms | Cleanup interval |
| `MAX_DATA_LEN_TCP` | 16384 | TCP buffer per endpoint |
| `MAX_DATA_LEN_UDP` | 65536 | Max UDP payload |
| `DEFAULT_MAX_CONNECTIONS` | 20000 | Connection limit |

## Logging

```rust
info!("message");    // Level 4 (default)
debug!("message");   // Level 5
trace!("message");   // Level 6
warn!("message");    // Level 3
error!("message");   // Level 2
fatal!("message");   // Level 1 (sets about_to_exit)
log_bare!("raw");    // No timestamp/level prefix
```

Enable with `--log-level <0-6>` or `--log-level fatal|error|warn|info|debug|trace`.

## Usage Examples

```bash
# TCP + UDP forwarding
./tinymapper -l0.0.0.0:1234 -r10.222.2.1:443 -t -u

# IPv6 support
./tinymapper -l[::]:1234 -r[2001:19f0:7001:1111::1]:443 -t -u

# 4to6 translation (IPv4 → ::ffff:x.x.x.x)
./tinymapper -l0.0.0.0:1234 -r[2001:19f0:7001:1111::1]:443 -t -u -4

# Debug logging
./tinymapper -l:1234 -r:443 -t -u --log-level debug --log-position

# Run unit tests
./tinymapper --run-test
```

## Key Implementation Details

- **Non-blocking I/O**: All sockets set `O_NONBLOCK`
- **Connection tracking**: Fd64 ↔ RawFd mapping via `FdManager`
- **UDP session lookup**: O(1) via `fd64_to_addr` HashMap
- **Stats output**: Every 10 seconds (TCP/UDP bytes, connection counts)
- **Graceful shutdown**: SIGTERM/SIGINT triggers cleanup and exit
- **Git version**: Auto-generated by `build.rs` (GIT_VERSION, BUILD_DATE)
